name: Daily Fetch Tailscale to Release

on:
  schedule:
    # æ¯å¤© UTC å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  fetch-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»ä¿ç•™ï¼Œç”¨äºå‘å¸ƒ Release

    steps:
      - name: è·å–æœ€æ–°ç‰ˆæœ¬å·å¹¶ä¸‹è½½æ–‡ä»¶
        run: |
          # 1. æŠ“å–å®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·
          VERSION=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | grep -Po '"tag_name": "v\K[^"]*')
          echo "TAILSCALE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "æ­£åœ¨æŠ“å–ç‰ˆæœ¬: $VERSION"
          
          # 2. Windows
          wget -nv -O tailscale-setup-latest.exe https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe
          
          # 3. Linux / OpenWrt å¿…å¤‡é€šç”¨é™æ€åŒ… (tgz)
          wget -nv -O tailscale_${VERSION}_amd64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz
          wget -nv -O tailscale_${VERSION}_arm64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm64.tgz
          
          # 4. Debian / Ubuntu ç¦»çº¿åŒ… (å·²ä¿®æ­£ä¸ºå®˜æ–¹çš„ pool éšè—è·¯å¾„)
          wget -nv -O tailscale_${VERSION}_amd64_ubuntu.deb https://pkgs.tailscale.com/stable/ubuntu/pool/tailscale_${VERSION}_amd64.deb
          wget -nv -O tailscale_${VERSION}_amd64_debian.deb https://pkgs.tailscale.com/stable/debian/pool/tailscale_${VERSION}_amd64.deb

      - name: åˆ é™¤æ—§çš„ Latest Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest --cleanup-tag -y || true

      - name: å‘å¸ƒå…¨æ–° Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Tailscale æœ€æ–°å…¨å¹³å°ç¦»çº¿åŒ…"
          body: |
            ### ğŸ¤– è‡ªåŠ¨åŒæ­¥å®Œæˆ
            - **å®˜æ–¹ç‰ˆæœ¬å·**: `v${{ env.TAILSCALE_VERSION }}`
            
            ä½ å¯ä»¥ä½¿ç”¨ `ghproxy` ç­‰é•œåƒæœåŠ¡åŠ é€Ÿä¸‹è½½ã€‚
            **âš ï¸ æç¤ºï¼šOpenWrt ç”¨æˆ·è¯·ç›´æ¥ä¸‹è½½ `.tgz` åŒ…ï¼Œè§£å‹æå–äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ã€‚**
          files: |
            *.exe
            *.tgz
            *.deb
