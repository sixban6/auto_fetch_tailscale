name: Daily Fetch Tailscale to Release

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´å‡Œæ™¨ 2 ç‚¹ (åŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹) è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # ä¾ç„¶ä¿ç•™æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®ï¼Œæ–¹ä¾¿ä½ éšæ—¶æµ‹è¯•

jobs:
  fetch-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆè„šæœ¬è¯»å†™ Releases çš„æƒé™

    steps:
      - name: è·å–æœ€æ–°ç‰ˆæœ¬å·å¹¶ä¸‹è½½æ–‡ä»¶
        run: |
          # 1. æŠ“å– Tailscale å®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·
          VERSION=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | grep -Po '"tag_name": "v\K[^"]*')
          echo "TAILSCALE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "æ­£åœ¨æŠ“å–ç‰ˆæœ¬: $VERSION"
          
          # 2. æ‰¹é‡ä¸‹è½½æ‰€æœ‰å¹³å°çš„å®‰è£…åŒ… (åŠ äº† -q å‚æ•°å‡å°‘æ—¥å¿—åˆ·å±)
          wget -q -O tailscale-setup-latest.exe https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe
          wget -q -O tailscale-latest.apk https://pkgs.tailscale.com/stable/tailscale-latest.apk
          wget -q -O tailscale_${VERSION}_amd64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz
          wget -q -O tailscale_${VERSION}_arm64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm64.tgz
          wget -q -O tailscale_${VERSION}_amd64_ubuntu.deb https://pkgs.tailscale.com/stable/ubuntu/jammy/tailscale_${VERSION}_amd64.deb
          wget -q -O tailscale_${VERSION}_amd64_debian.deb https://pkgs.tailscale.com/stable/debian/bookworm/tailscale_${VERSION}_amd64.deb

      - name: åˆ é™¤æ—§çš„ Latest Release (ä¿æŒä»“åº“æ•´æ´)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤åä¸º latest çš„å‘å¸ƒå’Œæ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·³è¿‡æŠ¥é”™
          gh release delete latest --cleanup-tag -y || true

      - name: å‘å¸ƒå…¨æ–° Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Tailscale æœ€æ–°å…¨å¹³å°ç¦»çº¿åŒ…"
          body: |
            ### ğŸ¤– è‡ªåŠ¨åŒæ­¥å®Œæˆ
            - **å®˜æ–¹ç‰ˆæœ¬å·**: `v${{ env.TAILSCALE_VERSION }}`
            - **æ›´æ–°æ—¶é—´**: è‡ªåŠ¨æ¯å¤©åŒæ­¥è¦†ç›–ï¼Œä¿æŒæœ€æ–°çŠ¶æ€ã€‚
            
            ä½ å¯ä»¥ä½¿ç”¨ `ghproxy` ç­‰é•œåƒæœåŠ¡åŠ é€Ÿä¸‹è½½ä»¥ä¸‹æ–‡ä»¶ã€‚
          files: |
            *.exe
            *.apk
            *.tgz
            *.deb
