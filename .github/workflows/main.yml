name: Daily Fetch Tailscale to Release

on:
  schedule:
    # æ¯å¤© UTC å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬å· (ç•™ç©ºåˆ™æŠ“å–å®˜æ–¹æœ€æ–°ç¨³å®šç‰ˆï¼Œæ— éœ€åŠ  v)'
        required: false
        default: ''

jobs:
  fetch-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: è·å–å®˜æ–¹ç»å¯¹æœ€æ–°ç‰ˆæœ¬å·å¹¶ä¸‹è½½
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            # æ”¾å¼ƒ GitHub APIï¼Œç›´æ¥ä» Tailscale å®˜æ–¹åŒ…æœåŠ¡å™¨è¯»å–æœ€æ–°ç¨³å®šç‰ˆ JSON
            VERSION=$(curl -s "https://pkgs.tailscale.com/stable/?mode=json" | jq -r .Version)
          fi
          
          # é˜²å‘†å¤„ç†ï¼šå¦‚æœæ‰‹åŠ¨è¾“å…¥äº†å¸¦ v çš„ç‰ˆæœ¬å· (å¦‚ v1.78.1)ï¼Œè‡ªåŠ¨å‰”é™¤ v
          VERSION="${VERSION#v}"
          
          echo "TAILSCALE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ¯ æˆåŠŸè·å–å®˜æ–¹æœ€æ–°ç‰ˆæœ¬: $VERSION"
          
          # Linux / OpenWrt å¿…å¤‡é€šç”¨é™æ€åŒ… (tgz)
          wget -nv -O tailscale_${VERSION}_amd64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz
          wget -nv -O tailscale_${VERSION}_arm64.tgz https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm64.tgz
          
          # Debian / Ubuntu ç¦»çº¿åŒ… (å®˜æ–¹ pool éšè—è·¯å¾„)
          wget -nv -O tailscale_${VERSION}_amd64_ubuntu.deb https://pkgs.tailscale.com/stable/ubuntu/pool/tailscale_${VERSION}_amd64.deb
          wget -nv -O tailscale_${VERSION}_amd64_debian.deb https://pkgs.tailscale.com/stable/debian/pool/tailscale_${VERSION}_amd64.deb

      - name: æ¸…ç†æ—§çš„ Release é¡µé¢
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest --cleanup-tag -y || true

      - name: å‘å¸ƒå…¨æ–° Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Tailscale æœ€æ–°å…¨å¹³å°ç¦»çº¿åŒ…"
          body: |
            ### ğŸ¤– è‡ªåŠ¨åŒæ­¥å®Œæˆ (ç›´è¿å®˜æ–¹æœåŠ¡å™¨ï¼Œé›¶å»¶è¿Ÿ)
            - **å®˜æ–¹ç¨³å®šç‰ˆæœ¬**: `${{ env.TAILSCALE_VERSION }}`
            
            ä½ å¯ä»¥ä½¿ç”¨ `ghproxy` ç­‰é•œåƒæœåŠ¡åŠ é€Ÿä¸‹è½½ã€‚
            **âš ï¸ æç¤ºï¼šOpenWrt ç”¨æˆ·è¯·ç›´æ¥ä¸‹è½½ `.tgz` åŒ…ï¼Œè§£å‹æå–äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ã€‚**
          files: |
            *.tgz
            *.deb
