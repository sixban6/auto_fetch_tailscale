#!/bin/sh

# ==========================================
# 0. é˜²æ­¢è„šæœ¬å¤šå¼€é” (OpenWrt åŽŸç”Ÿ PID é”)
# ==========================================
LOCK_FILE="/var/run/singbox_watchdog.pid"
LOG_FILE="/var/log/watchdog.log"

if [ -f "$LOCK_FILE" ]; then
    # è¯»å–æ—§çš„è¿›ç¨‹å·
    OLD_PID=$(cat "$LOCK_FILE")
    # æ£€æŸ¥è¯¥è¿›ç¨‹å·æ˜¯å¦è¿˜åœ¨è¿è¡Œ
    if kill -0 "$OLD_PID" 2>/dev/null; then
        echo "$(date +'%Y-%m-%d %H:%M:%S') | âš ï¸ ä¸Šä¸€ä¸ª watchdog ä»»åŠ¡(PID: $OLD_PID)ä»åœ¨è¿è¡Œï¼Œæœ¬æ¬¡è·³è¿‡ã€‚" >> "$LOG_FILE"
        exit 1
    else
        # è¿›ç¨‹å·²ç»ä¸åœ¨äº†ï¼Œè¯´æ˜Žæ˜¯ä¸Šæ¬¡æ„å¤–ä¸­æ–­ç•™ä¸‹çš„æ­»é”ï¼Œæ¸…ç†æŽ‰
        rm -f "$LOCK_FILE"
    fi
fi

# å°†å½“å‰è„šæœ¬çš„è¿›ç¨‹å·å†™å…¥é”æ–‡ä»¶
echo $$ > "$LOCK_FILE"

# å…³é”®ï¼šæ— è®ºè„šæœ¬æ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯æŠ¥é”™å´©æºƒï¼Œé€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤é”æ–‡ä»¶
trap 'rm -f "$LOCK_FILE"' EXIT INT TERM

# ==========================================
# 1. åŸºç¡€é…ç½®ä¸Žæ—¥å¿—è½®è½¬ (ä¿ç•™3å¤©)
# ==========================================
LOG_FILE="/var/log/watchdog.log"
TODAY=$(date +'%Y-%m-%d')
TIMEOUT=10
PROXY_PARAM="-x socks5h://127.0.0.1:2080" # å¦‚æžœæœ¬æœºç›´è¿žä¸èµ°ä»£ç†ï¼Œè¯·è§£å¼€å¹¶é…ç½®æ­£ç¡®ç«¯å£

# å†™å…¥æ—¥å¿—çš„è¾…åŠ©å‡½æ•°ï¼Œç»Ÿä¸€å¸¦ä¸Šæ—¶é—´æˆ³
log() {
    echo "$(date +'%Y-%m-%d %H:%M:%S') | $1" >> "$LOG_FILE"
}

# ç®€å•çš„æ—¥å¿—å½’æ¡£é€»è¾‘ (OpenWrt sh å…¼å®¹å†™æ³•)
if [ -f "$LOG_FILE" ]; then
    # è¯»å–æ—¥å¿—ç¬¬ä¸€è¡Œçš„æ—¶é—´æˆ³æ¥åˆ¤æ–­å±žäºŽå“ªä¸€å¤©
    FIRST_LINE_DATE=$(head -n 1 "$LOG_FILE" | awk '{print $1}')
    
    # ä½¿ç”¨ grep -E æ›¿ä»£ bash çš„ [[ =~ ]] è¿›è¡Œæ­£åˆ™åˆ¤æ–­
    if echo "$FIRST_LINE_DATE" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
        if [ "$FIRST_LINE_DATE" != "$TODAY" ]; then
            mv "$LOG_FILE" "/var/log/watchdog_${FIRST_LINE_DATE}.log"
        fi
    fi
fi

# æ¸…ç† 3 å¤©å‰çš„åŽ†å²å½’æ¡£ (å…¼å®¹ BusyBox findï¼Œæ”¾å¼ƒ -delete æ”¹ç”¨ -exec)
find /var/log/ -name "watchdog_[0-9][0-9][0-9][0-9]-*.log" -type f -mtime +2 -exec rm -f {} \; 2>/dev/null

# ==========================================
# 2. ç½‘ç»œæŽ¢æµ‹å‡½æ•°
# ==========================================
check_proxy() {
    local max_attempts=$1
    # å…¼å®¹ sh çš„ seq æ›¿ä»£æ–¹æ¡ˆï¼Œå› ä¸ºéƒ¨åˆ†ç²¾ç®€ç‰ˆ OpenWrt æ²¡æœ‰ seq å‘½ä»¤
    local i=1
    while [ "$i" -le "$max_attempts" ]; do
        if curl $PROXY_PARAM -s -I -m "$TIMEOUT" https://www.google.com > /dev/null; then
            return 0 # ä»£ç†è¿žé€šæˆåŠŸ
        fi
        [ "$i" -lt "$max_attempts" ] && sleep 3
        i=$((i + 1))
    done
    return 1 # ä»£ç†è¿žé€šå¤±è´¥
}

check_isp() {
    # ä¸èµ°ä»£ç†ï¼Œç›´è¿žæµ‹è¯•å›½å†…ç½‘ç«™ä¸Žå…¬å…±DNSï¼Œåˆ¤æ–­ç‰©ç†å®½å¸¦æ˜¯å¦æ­£å¸¸
    if curl -s -I -m 5 https://www.baidu.com > /dev/null || ping -c 2 -W 3 223.5.5.5 > /dev/null; then
        return 0 # å®½å¸¦æ­£å¸¸
    else
        return 1 # å®½å¸¦æ–­ç½‘
    fi
}

# ==========================================
# 3. æ ¸å¿ƒæ•‘æ´é€»è¾‘ (è½¯é‡å¯ -> å¤æµ‹ -> ç´§æ€¥å›žæ»š)
# ==========================================
execute_rescue() {
    log "ðŸ”§ å¯åŠ¨ [ç¬¬ä¸€çº§æ•‘æ´]: ä¿ç•™å½“å‰é…ç½®ï¼Œä»…é‡å¯æœåŠ¡..."
    singctl sb stop 2>/dev/null
    sleep 3
    singctl sb start || singctl sb stop
    
    # æŒ‰ç…§è¦æ±‚ä¿®æ”¹ä¸º 90 ç§’
    log "â³ ç­‰å¾… 90 ç§’è®©èŠ‚ç‚¹å»ºç«‹è¿žæŽ¥..."
    sleep 90
    
    log "ðŸ”„ å¼€å§‹äºŒæ¬¡å¤æµ‹..."
    if check_proxy 3; then
        log "âœ… äºŒæ¬¡å¤æµ‹é€šè¿‡ï¼æœåŠ¡è½¯é‡å¯æˆåŠŸã€‚"
    else
        log "ðŸ’€ äºŒæ¬¡å¤æµ‹å¤±è´¥ï¼Œå½“å‰é…ç½®æˆ–èŠ‚ç‚¹å¯èƒ½å·²å¤±æ•ˆã€‚"
        log "ðŸ’£ å¯åŠ¨ [ç¬¬äºŒçº§æ•‘æ´]: å‡†å¤‡æ‰§è¡Œç´§æ€¥é…ç½®å›žæ»š..."
        
        singctl sb stop 2>/dev/null
        
        if [ -f "/etc/sing-box/config.json.bak" ]; then
            cp /etc/sing-box/config.json.bak /etc/sing-box/config.json
            log "ðŸ”„ å·²ç”¨ config.json.bak è¦†ç›–å½“å‰é…ç½®ã€‚"
        else
            log "âŒ è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ°å¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œæ— æ³•å›žæ»šï¼"
        fi
        
        sleep 3
        singctl sb start || singctl sb stop
        log "âœ… ç´§æ€¥å›žæ»šæ‰§è¡Œå®Œæ¯•ï¼Œç­‰å¾…ä¸‹ä¸€è½®å·¡æ£€ã€‚"
    fi
}

# ==========================================
# 4. ä¸»æµç¨‹å¼€å§‹
# ==========================================
# æŒ‰ç…§è¦æ±‚ä¿®æ”¹ä¸º 13 æ¬¡å¸¸è§„ä»£ç†æ£€æµ‹
if check_proxy 13; then
    log "âœ… å¸¸è§„å·¡æ£€é€šè¿‡ï¼Œä»£ç†é¡ºç•…ã€‚"
    exit 0
fi

log "ðŸš¨ è¿žç»­ 13 æ¬¡æŽ¢æµ‹ä»£ç†å¤±è´¥ï¼Œæ­£åœ¨æŽ’æŸ¥ç½‘ç»œçŽ¯å¢ƒ..."

# æ­¥éª¤äºŒï¼šå…¼å®¹ä¸»/æ—è·¯ç”±çš„â€œé˜²èƒŒé”…â€æ£€æµ‹
if check_isp; then
    log "âš ï¸ å›½å†…ç½‘ç»œæ­£å¸¸ã€‚ç¡®è®¤ä¸ºã€ä»£ç†æœåŠ¡å´©æºƒã€‘ï¼Œå‡†å¤‡æ‰§è¡Œæ•‘æ´ã€‚"
    execute_rescue
else
    log "âš ï¸ å›½å†…ç½‘ç»œä¹Ÿä¸é€šï¼æ­£åœ¨æŽ’æŸ¥æ˜¯ç‰©ç†æ–­ç½‘ï¼Œè¿˜æ˜¯é€æ˜Žä»£ç†å¡æ­»å¯¼è‡´å…¨å±€æ–­ç½‘..."
    
    # æ ¸å¿ƒåŠ¨ä½œï¼šåœæŽ‰ä»£ç†ï¼Œæ¸…é™¤æ®‹ç•™çš„è·¯ç”±åŠ«æŒè§„åˆ™
    singctl sb stop 2>/dev/null
    sleep 3
    
    if check_isp; then
        log "âœ… å…³é—­ä»£ç†åŽå›½å†…ç½‘ç»œæ¢å¤ï¼ç¡®è®¤ä¸ºã€ä»£ç†è§„åˆ™æ®‹ç•™å¯¼è‡´å…¨å±€æ–­ç½‘ã€‘ã€‚å‡†å¤‡æ‰§è¡Œæ•‘æ´ã€‚"
        execute_rescue
    else
        log "ðŸ’€ å…³é—­ä»£ç†åŽå›½å†…ä¾ç„¶æ–­ç½‘ï¼Œç¡®è®¤ä¸ºã€ç‰©ç†å®½å¸¦/ä¸»è·¯ç”± çœŸå®žæ•…éšœã€‘ï¼"
        log "â¸ï¸ ä¸ºé˜²æ­¢è¯¯ä¼¤é…ç½®ï¼ŒæŒ‚èµ·æœ¬æ¬¡æ•‘æ´ã€‚ä»…æ¢å¤ä»£ç†è¿è¡ŒçŠ¶æ€ï¼Œç­‰å¾…ç‰©ç†ç½‘ç»œæ¢å¤ã€‚"
        # å®½å¸¦æ–­äº†ï¼Œåˆ«ä¹±åŠ¨é…ç½®ï¼ŒæŠŠä»£ç†é‡æ–°è·‘èµ·æ¥ç­‰å®½å¸¦æ¢å¤å°±å¥½
        singctl sb start >/dev/null 2>&1
        exit 0
    fi
fi
